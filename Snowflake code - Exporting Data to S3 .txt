-- üîê SWITCH TO ACCOUNTADMIN ROLE TO ENSURE YOU HAVE FULL PERMISSIONS
USE ROLE ACCOUNTADMIN;

-- üë§ CREATE A NEW ROLE CALLED 'TRANSFORM' IF IT DOESN'T ALREADY EXIST
CREATE ROLE IF NOT EXISTS TRANSFORM;

-- üîê GRANT THE TRANSFORM ROLE TO THE ACCOUNTADMIN FOR ADMINISTRATION
GRANT ROLE TRANSFORM TO ROLE ACCOUNTADMIN;

-- ‚öôÔ∏è CREATE A COMPUTE WAREHOUSE FOR PROCESSING QUERIES (IF NOT ALREADY PRESENT)
CREATE WAREHOUSE IF NOT EXISTS COMPUTE_WH;

-- ‚úÖ GIVE THE TRANSFORM ROLE PERMISSION TO USE THE WAREHOUSE
GRANT OPERATE ON WAREHOUSE COMPUTE_WH TO ROLE TRANSFORM;

-- üóÉÔ∏è CREATE DATABASE AND SCHEMA TO STORE RAW DATA
CREATE DATABASE IF NOT EXISTS HOSPITAL;
CREATE SCHEMA IF NOT EXISTS HOSPITAL.RAW;

-- üë§ CREATE A USER FOR DBT (DATA BUILD TOOL) AUTOMATION PURPOSES
CREATE USER IF NOT EXISTS dbt
  PASSWORD = '*********'  -- üîë SET USER PASSWORD
  LOGIN_NAME = 'dbt'       -- üë§ LOGIN ALIAS
  MUST_CHANGE_PASSWORD = FALSE
  DEFAULT_WAREHOUSE = 'COMPUTE_WH'
  DEFAULT_ROLE = TRANSFORM
  DEFAULT_NAMESPACE = 'HOSPITAL.RAW'
  COMMENT = 'DBT user for transformations';

-- ‚öôÔ∏è SET USER TYPE FOR SERVICE ACCOUNT
ALTER USER dbt SET TYPE = LEGACY_SERVICE;

-- üîê GRANT TRANSFORM ROLE TO DBT USER
GRANT ROLE TRANSFORM TO USER dbt;

-- ‚úÖ GRANT REQUIRED ACCESS TO ROLE FOR WAREHOUSE AND DATABASE OBJECTS
GRANT ALL ON WAREHOUSE COMPUTE_WH TO ROLE TRANSFORM;
GRANT ALL ON DATABASE HOSPITAL TO ROLE TRANSFORM;
GRANT ALL ON ALL SCHEMAS IN DATABASE HOSPITAL TO ROLE TRANSFORM;
GRANT ALL ON FUTURE SCHEMAS IN DATABASE HOSPITAL TO ROLE TRANSFORM;
GRANT ALL ON ALL TABLES IN SCHEMA HOSPITAL.RAW TO ROLE TRANSFORM;
GRANT ALL ON FUTURE TABLES IN SCHEMA HOSPITAL.RAW TO ROLE TRANSFORM;

-- üõ¢Ô∏è CREATE AN EXTERNAL STAGE POINTING TO S3 BUCKET FOR LOADING DATA
CREATE OR REPLACE STAGE hospital_stage
  URL = 's3://your-bucket-name'
  CREDENTIALS = (
    AWS_KEY_ID = '********************',
    AWS_SECRET_KEY = '***************'
  );

-- üì¶ VERIFY FILES IN STAGE (OPTIONAL)
LIST @hospital_stage;

-- üì• CREATE RAW TABLES AND LOAD DATA FROM CSV FILES IN S3 STAGE

-- üßæ ADMISSIONS TABLE
CREATE OR REPLACE TABLE raw_admissions (
  patient_id STRING,
  admission_id STRING,
  admit_time TIMESTAMP,
  department STRING,
  bed_id STRING,
  admission_type STRING,
  age INTEGER,
  gender STRING,
  primary_diagnosis STRING,
  insurance_type STRING
);

COPY INTO raw_admissions
FROM '@hospital_stage/admissions.csv'
FILE_FORMAT = (TYPE = 'CSV' FIELD_OPTIONALLY_ENCLOSED_BY = '"' SKIP_HEADER = 1);

-- üõèÔ∏è BED INVENTORY TABLE
CREATE OR REPLACE TABLE raw_bed_inventory (
  bed_id STRING,
  department STRING,
  bed_status STRING,
  last_updated TIMESTAMP,
  room_number STRING,
  bed_type STRING,
  is_critical_care BOOLEAN
);

COPY INTO raw_bed_inventory
FROM '@hospital_stage/bed_inventory.csv'
FILE_FORMAT = (TYPE = 'CSV' FIELD_OPTIONALLY_ENCLOSED_BY = '"' SKIP_HEADER = 1);

-- üîÅ TRANSFERS TABLE
CREATE OR REPLACE TABLE raw_transfers (
  patient_id STRING,
  admission_id STRING,
  transfer_time TIMESTAMP,
  from_department STRING,
  to_department STRING,
  reason STRING
);

COPY INTO raw_transfers
FROM '@hospital_stage/transfers.csv'
FILE_FORMAT = (TYPE = 'CSV' FIELD_OPTIONALLY_ENCLOSED_BY = '"' SKIP_HEADER = 1);

-- üèÅ DISCHARGES TABLE
CREATE OR REPLACE TABLE raw_discharges (
  patient_id STRING,
  admission_id STRING,
  discharge_time TIMESTAMP,
  discharge_status STRING,
  department STRING,
  length_of_stay INTEGER,
  discharge_destination STRING
);

COPY INTO raw_discharges
FROM '@hospital_stage/discharges.csv'
FILE_FORMAT = (TYPE = 'CSV' FIELD_OPTIONALLY_ENCLOSED_BY = '"' SKIP_HEADER = 1);

-- ‚¨ÜÔ∏è EXPORT PROCESSED DIMENSIONS AND FACT TABLES TO S3 (USEFUL FOR BACKUP OR SHARING)
CREATE OR REPLACE STAGE hospital_s3_stage
  URL = 's3://your-bucket-name'
  STORAGE_INTEGRATION = your_snowflake_integration;

-- EXPORT EACH TRANSFORMED TABLE TO S3
COPY INTO @hospital_s3_stage/dim_patient/
FROM HOSPITAL.HOSPITAL_DATA.DIM_PATIENT
FILE_FORMAT = (TYPE = 'CSV' FIELD_DELIMITER = ',' OVERWRITE = TRUE SINGLE = TRUE);

COPY INTO @hospital_s3_stage/dim_department/
FROM HOSPITAL.HOSPITAL_DATA.DIM_DEPARTMENT
FILE_FORMAT = (TYPE = 'CSV' FIELD_DELIMITER = ',' OVERWRITE = TRUE SINGLE = TRUE);

COPY INTO @hospital_s3_stage/dim_bed/
FROM HOSPITAL.HOSPITAL_DATA.DIM_BED
FILE_FORMAT = (TYPE = 'CSV' FIELD_DELIMITER = ',' OVERWRITE = TRUE SINGLE = TRUE);

COPY INTO @hospital_s3_stage/fact_admission_events/
FROM HOSPITAL.HOSPITAL_DATA.FACT_ADMISSION_EVENTS
FILE_FORMAT = (TYPE = 'CSV' FIELD_DELIMITER = ',' OVERWRITE = TRUE SINGLE = TRUE);

COPY INTO @hospital_s3_stage/fact_transfer_events/
FROM HOSPITAL.HOSPITAL_DATA.FACT_TRANSFER_EVENTS
FILE_FORMAT = (TYPE = 'CSV' FIELD_DELIMITER = ',' OVERWRITE = TRUE SINGLE = TRUE);
